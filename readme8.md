## ИДЗ 2 ОС Дергилёв Марк БПИ 236 Вариант 36

### Условие задачи

«Камень, ножницы, бумага» 2 — олимпийская система.
N cтудентов, изнывающих от скуки на лекции по операционным
системам решили организовать турнир в игру «Камень, ножницы,
бумага» по олимпийской системе (с выбыванием). В случае ничей
(выпадение одинаковых предметов) игра продолжается до победы
одного из участников.
Требуется создать многопроцессное приложение, моделирующее турнир.
Каждый студент — отдельный процесс. Генерация камня, ножниц и бумаги в каждом процессе формируется случайно.


## Описание архитектуры решения:
Используются семафоры и разделяемая память System V. Решение на 8.

Файл: `main_sysv.cpp`

Кол-во игроков в турнире генерируется случайно в диапазоне от 2 до 100. 

У нас есть две сущности: основная программа и процессы-игроки.

Турнир организован по олимпийской системе, количество раундов = $ log_2 N $ с округлением вверх, где N - количество игроков в турнире. Игрок без соперника сразу проходит в следующий раунд. Обращение к глобальной памяти происходит с блокировкой семафора (в данном случае мьютекса) для обеспечения отсутствия гонок данных.

Для удобной работы с System V семафорами были написаны две функции: `sem_post_sysv` и `sem_wait_sysv`. Думаю, что по названию понятно, что делают эти функции.

<b>Логика работы главной программы:</b>
- Главная программа создает и инициализирует разделяемую память с состоянием турнира.
- Главная программа создает набор PRIVATE семафоров:
    - Главный (мьютекс) для обращения к разделяемой памяти. Имеет номер 0
    - Семафор для получения сообщения от игроков, что выбор сделан. Имеет номер 1
    - Личные семафоры для каждого игрока (потребуются для того чтобы затриггерить ход игрока из главной программы)
- Запускает N процессов игроков и сохраняет их PID для обработки завершения
- Запускает цикл для раундов
  - генерируются пары
  - игрок без пары проходит в след этап
  - для каждой пары в цикле ждем пока игроки походят и определится победитель. Если ничья, то цикл продолжается.
  - после определения победителя обновляю состояние турнира
  - если остался 1 игрок - завершается турнир
- Освобождает ресурсы



<b>Логика работы процесса игрока:</b>
- ждет пока главный процесс разблокирует семафор игрока
- проверяет не кончился ли турнир и при положительном результате - завершается
- проверяет находится ли он в игре обращением к разделяемой памяти - если нет, то завершается
- делает ход и кладет его в разделяемую память в свою ячейку для ходов
- делает sem_post для семафора готовности раунда, обрабатываемого в основной программе


При завершении программы самостоятельно или по сигналу SIGINT происходит очистка всех ресурсов: закрытие семафоров и дальнейший unlink, закрытие shared memory

#### Пример логов программы:
```
Количество игроков в турнире: 8

Раунд 1
Матч между 1 и 2
   Игрок 1 выбрал камень
   Игрок 2 выбрал бумага
  Игрок 2 победил
Матч между 3 и 4
   Игрок 3 выбрал камень
   Игрок 4 выбрал бумага
  Игрок 4 победил
Матч между 5 и 6
   Игрок 5 выбрал камень
   Игрок 6 выбрал ножницы
  Игрок 5 победил
Матч между 7 и 8
   Игрок 7 выбрал бумага
   Игрок 8 выбрал бумага
  Ничья, матч переигрывается...
   Игрок 7 выбрал камень
   Игрок 8 выбрал камень
  Ничья, матч переигрывается...
   Игрок 7 выбрал бумага
   Игрок 8 выбрал ножницы
  Игрок 8 победил

Раунд 2
Матч между 2 и 4
   Игрок 2 выбрал камень
   Игрок 4 выбрал бумага
  Игрок 4 победил
Матч между 5 и 8
   Игрок 5 выбрал бумага
   Игрок 8 выбрал бумага
  Ничья, матч переигрывается...
   Игрок 5 выбрал бумага
   Игрок 8 выбрал ножницы
  Игрок 8 победил

Раунд 3
Матч между 4 и 8
   Игрок 4 выбрал камень
   Игрок 8 выбрал камень
  Ничья, матч переигрывается...
   Игрок 4 выбрал ножницы
   Игрок 8 выбрал бумага
  Игрок 4 победил

Турнир закончен, выиграл игрок под номером: 4
```
