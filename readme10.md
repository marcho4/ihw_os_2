## ИДЗ 2 ОС Дергилёв Марк БПИ 236 Вариант 36

### Условие задачи

«Камень, ножницы, бумага» 2 — олимпийская система.
N cтудентов, изнывающих от скуки на лекции по операционным
системам решили организовать турнир в игру «Камень, ножницы,
бумага» по олимпийской системе (с выбыванием). В случае ничей
(выпадение одинаковых предметов) игра продолжается до победы
одного из участников.
Требуется создать многопроцессное приложение, моделирующее турнир.
Каждый студент — отдельный процесс. Генерация камня, ножниц и бумаги в каждом процессе формируется случайно.


## Описание архитектуры решения:
Используется очередь сообщений и семафоры System V. Решение на 10 баллов.

Файл: `main_sysv_mq.cpp` 

Кол-во игроков в турнире генерируется случайно в диапазоне от 2 до 100. 

У нас есть две сущности: основная программа и процессы-игроки.

Турнир организован по олимпийской системе, количество раундов = $ log_2 N $ с округлением вверх, где N - количество игроков в турнире. Игрок без соперника сразу проходит в следующий раунд.

Была создана структура `MoveMsg` для сообщений о ходах игроков: `id`, `move` и `mtype`.

За счет использования очереди сообщений, я избавился от семафоров для ожидания ходов игроков, так как операция чтения из очереди является блокирующей, а также от мьютекса для доступа к состоянию.

 Пришлось принудительно завершать дочерние процессы, так как теперь у нас нет возможности проверить состояние турнира из общей памяти. Для них был установлен дефолтный обработчик SIGINT, чтобы не происходило высвобождение ресурсов по моей логике в дочерних процессах.

<b>Логика работы главной программы:</b>
- Главная программа создает очередь сообщений.
- Главная программа создает набор семафоров:
    - Главный (мьютекс) для обращения к разделяемой памяти.
    - Личные семафоры для каждого игрока (потребуются для того чтобы затриггерить ход игрока из главной программы).
- Запускает N процессов игроков и сохраняет их PID для обработки завершения
- Запускает цикл для раундов
  - генерируются пары
  - игрок без пары проходит в след этап
  - для каждой пары в цикле ждем пока игроки походят (отправят сообщение в очередь) и определится победитель. Если ничья, то цикл продолжается.
  - если остался 1 игрок - завершается турнир
- Освобождает ресурсы


<b>Логика работы процесса игрока:</b>
- ждет пока главный процесс разблокирует семафор игрока
- делает ход и отправляет сообщение в очередь сообщений


При завершении программы самостоятельно или по сигналу SIGINT происходит очистка всех ресурсов: закрытие семафоров и удаление очереди сообщений. Очистка была выделена в отдельную функцию `cleanup()`

#### Пример логов программы:
```
Количество игроков в турнире: 54

Раунд 1
Матч между 1 и 2
   Игрок 1 выбрал камень
   Игрок 2 выбрал бумага
  Игрок 2 победил
Матч между 3 и 4
   Игрок 3 выбрал камень
   Игрок 4 выбрал ножницы
  Игрок 3 победил
Матч между 5 и 6
   Игрок 5 выбрал бумага
   Игрок 6 выбрал ножницы
  Игрок 6 победил
Матч между 7 и 8
   Игрок 8 выбрал бумага
   Игрок 7 выбрал ножницы
  Игрок 7 победил
Матч между 9 и 10
   Игрок 10 выбрал камень
   Игрок 9 выбрал бумага
  Игрок 9 победил
Матч между 11 и 12
   Игрок 11 выбрал ножницы
   Игрок 12 выбрал бумага
  Игрок 11 победил
Матч между 13 и 14
   Игрок 13 выбрал ножницы
   Игрок 14 выбрал бумага
  Игрок 13 победил
Матч между 15 и 16
   Игрок 15 выбрал ножницы
   Игрок 16 выбрал бумага
  Игрок 15 победил
Матч между 17 и 18
   Игрок 17 выбрал бумага
   Игрок 18 выбрал камень
  Игрок 17 победил
Матч между 19 и 20
   Игрок 19 выбрал камень
   Игрок 20 выбрал бумага
  Игрок 20 победил
Матч между 21 и 22
   Игрок 21 выбрал камень
   Игрок 22 выбрал бумага
  Игрок 22 победил
Матч между 23 и 24
   Игрок 23 выбрал бумага
   Игрок 24 выбрал бумага
  Ничья, матч переигрывается...
   Игрок 24 выбрал камень
   Игрок 23 выбрал ножницы
  Игрок 24 победил
Матч между 25 и 26
   Игрок 25 выбрал бумага
   Игрок 26 выбрал бумага
  Ничья, матч переигрывается...
   Игрок 26 выбрал бумага
   Игрок 25 выбрал ножницы
  Игрок 25 победил
Матч между 27 и 28
   Игрок 27 выбрал камень
   Игрок 28 выбрал камень
  Ничья, матч переигрывается...
   Игрок 27 выбрал ножницы
   Игрок 28 выбрал ножницы
  Ничья, матч переигрывается...
   Игрок 27 выбрал бумага
   Игрок 28 выбрал ножницы
  Игрок 28 победил
Матч между 29 и 30
   Игрок 29 выбрал ножницы
   Игрок 30 выбрал ножницы
  Ничья, матч переигрывается...
   Игрок 30 выбрал камень
   Игрок 29 выбрал камень
  Ничья, матч переигрывается...
   Игрок 29 выбрал бумага
   Игрок 30 выбрал ножницы
  Игрок 30 победил
Матч между 31 и 32
   Игрок 31 выбрал ножницы
   Игрок 32 выбрал бумага
  Игрок 31 победил
Матч между 33 и 34
   Игрок 33 выбрал камень
   Игрок 34 выбрал ножницы
  Игрок 33 победил
Матч между 35 и 36
   Игрок 35 выбрал бумага
   Игрок 36 выбрал ножницы
  Игрок 36 победил
Матч между 37 и 38
   Игрок 38 выбрал ножницы
   Игрок 37 выбрал бумага
  Игрок 38 победил
Матч между 39 и 40
   Игрок 40 выбрал ножницы
   Игрок 39 выбрал камень
  Игрок 39 победил
Матч между 41 и 42
   Игрок 41 выбрал камень
   Игрок 42 выбрал камень
  Ничья, матч переигрывается...
   Игрок 41 выбрал ножницы
   Игрок 42 выбрал ножницы
  Ничья, матч переигрывается...
   Игрок 41 выбрал камень
   Игрок 42 выбрал бумага
  Игрок 42 победил
Матч между 43 и 44
   Игрок 43 выбрал камень
   Игрок 44 выбрал ножницы
  Игрок 43 победил
Матч между 45 и 46
   Игрок 45 выбрал бумага
   Игрок 46 выбрал ножницы
  Игрок 46 победил
Матч между 47 и 48
   Игрок 47 выбрал камень
   Игрок 48 выбрал бумага
  Игрок 48 победил
Матч между 49 и 50
   Игрок 49 выбрал ножницы
   Игрок 50 выбрал бумага
  Игрок 49 победил
Матч между 51 и 52
   Игрок 51 выбрал камень
   Игрок 52 выбрал камень
  Ничья, матч переигрывается...
   Игрок 51 выбрал камень
   Игрок 52 выбрал камень
  Ничья, матч переигрывается...
   Игрок 51 выбрал бумага
   Игрок 52 выбрал ножницы
  Игрок 52 победил
Матч между 53 и 54
   Игрок 53 выбрал ножницы
   Игрок 54 выбрал камень
  Игрок 54 победил

Раунд 2
Студент 54 проходит в следующий раунд
Матч между 2 и 3
   Игрок 2 выбрал бумага
   Игрок 3 выбрал ножницы
  Игрок 3 победил
Матч между 6 и 8
   Игрок 6 выбрал камень
   Игрок 8 выбрал бумага
  Игрок 8 победил
Матч между 10 и 11
   Игрок 10 выбрал камень
   Игрок 11 выбрал бумага
  Игрок 11 победил
Матч между 13 и 15
   Игрок 15 выбрал камень
   Игрок 13 выбрал ножницы
  Игрок 15 победил
Матч между 17 и 20
   Игрок 17 выбрал ножницы
   Игрок 20 выбрал ножницы
  Ничья, матч переигрывается...
   Игрок 17 выбрал бумага
   Игрок 20 выбрал бумага
  Ничья, матч переигрывается...
   Игрок 17 выбрал бумага
   Игрок 20 выбрал камень
  Игрок 17 победил
Матч между 22 и 23
   Игрок 22 выбрал камень
   Игрок 23 выбрал ножницы
  Игрок 22 победил
Матч между 26 и 28
   Игрок 26 выбрал бумага
   Игрок 28 выбрал бумага
  Ничья, матч переигрывается...
   Игрок 28 выбрал камень
   Игрок 26 выбрал бумага
  Игрок 26 победил
Матч между 30 и 31
   Игрок 30 выбрал бумага
   Игрок 31 выбрал бумага
  Ничья, матч переигрывается...
   Игрок 30 выбрал камень
   Игрок 31 выбрал бумага
  Игрок 31 победил
Матч между 33 и 36
   Игрок 36 выбрал ножницы
   Игрок 33 выбрал ножницы
  Ничья, матч переигрывается...
   Игрок 33 выбрал бумага
   Игрок 36 выбрал камень
  Игрок 33 победил
Матч между 37 и 40
   Игрок 37 выбрал ножницы
   Игрок 40 выбрал камень
  Игрок 40 победил
Матч между 42 и 43
   Игрок 42 выбрал ножницы
   Игрок 43 выбрал камень
  Игрок 43 победил
Матч между 46 и 48
   Игрок 46 выбрал бумага
   Игрок 48 выбрал камень
  Игрок 46 победил
Матч между 49 и 52
   Игрок 49 выбрал камень
   Игрок 52 выбрал ножницы
  Игрок 49 победил

Раунд 3
Матч между 54 и 3
   Игрок 54 выбрал ножницы
   Игрок 3 выбрал камень
  Игрок 3 победил
Матч между 8 и 11
   Игрок 8 выбрал камень
   Игрок 11 выбрал камень
  Ничья, матч переигрывается...
   Игрок 8 выбрал бумага
   Игрок 11 выбрал ножницы
  Игрок 11 победил
Матч между 13 и 17
   Игрок 13 выбрал ножницы
   Игрок 17 выбрал ножницы
  Ничья, матч переигрывается...
   Игрок 13 выбрал бумага
   Игрок 17 выбрал камень
  Игрок 13 победил
Матч между 22 и 28
   Игрок 22 выбрал ножницы
   Игрок 28 выбрал бумага
  Игрок 22 победил
Матч между 31 и 33
   Игрок 31 выбрал ножницы
   Игрок 33 выбрал ножницы
  Ничья, матч переигрывается...
   Игрок 33 выбрал камень
   Игрок 31 выбрал ножницы
  Игрок 33 победил
Матч между 40 и 43
   Игрок 40 выбрал бумага
   Игрок 43 выбрал бумага
  Ничья, матч переигрывается...
   Игрок 40 выбрал бумага
   Игрок 43 выбрал камень
  Игрок 40 победил
Матч между 46 и 49
   Игрок 49 выбрал ножницы
   Игрок 46 выбрал бумага
  Игрок 49 победил

Раунд 4
Студент 46 проходит в следующий раунд
Матч между 3 и 11
   Игрок 3 выбрал ножницы
   Игрок 11 выбрал бумага
  Игрок 3 победил
Матч между 13 и 22
   Игрок 22 выбрал ножницы
   Игрок 13 выбрал бумага
  Игрок 22 победил
Матч между 31 и 40
   Игрок 31 выбрал бумага
   Игрок 40 выбрал бумага
  Ничья, матч переигрывается...
   Игрок 31 выбрал ножницы
   Игрок 40 выбрал бумага
  Игрок 31 победил

Раунд 5
Матч между 46 и 3
   Игрок 46 выбрал ножницы
   Игрок 3 выбрал камень
  Игрок 3 победил
Матч между 13 и 31
   Игрок 13 выбрал ножницы
   Игрок 31 выбрал ножницы
  Ничья, матч переигрывается...
   Игрок 31 выбрал камень
   Игрок 13 выбрал камень
  Ничья, матч переигрывается...
   Игрок 31 выбрал камень
   Игрок 13 выбрал ножницы
  Игрок 31 победил

Раунд 6
Матч между 3 и 13
   Игрок 13 выбрал бумага
   Игрок 3 выбрал ножницы
  Игрок 3 победил

Турнир закончен, выиграл игрок под номером: 13
```
